<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cosmic Care</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-status-bar-style" content="white">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700&family=Courier+Prime&family=Caveat:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f3e5f5;
      --accent: #ab47bc;
      --text: #4a148c;
      --paper: #fff;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: "Quicksand", sans-serif;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.5s ease;
      padding: 20px;
      box-sizing: border-box;
    }

    /* CONTROLS */
    .controls {
      width: 100%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .name-box {
      background: rgba(255,255,255,0.9);
      border: 2px solid var(--accent);
      padding: 16px;
      border-radius: 25px;
      font-family: "Quicksand", sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      color: var(--text);
      outline: none;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .sign-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .sign-btn {
      background: rgba(255,255,255,0.8);
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 15px 5px;
      border-radius: 18px;
      font-weight: 700;
      font-size: 0.8rem;
      cursor: pointer;
      transition: transform 0.1s;
      text-transform: uppercase;
    }
    .sign-btn:active { transform: scale(0.95); background: var(--accent); color: #fff; }

    .menu-btn {
      color: white;
      border: none;
      padding: 12px;
      border-radius: 99px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .stats-btn { background: var(--accent); }
    .rx-btn { background: #ff80ab; margin-top: -5px; }

    /* CONTAINERS */
    .receipt-container, .report-container, .rx-container {
      perspective: 1000px;
      width: 100%;
      max-width: 340px;
      display: none;
    }

    /* RECEIPT STYLES */
    .receipt, .report {
      background: var(--paper);
      padding: 30px 25px;
      font-family: "Courier Prime", monospace;
      color: var(--text);
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      animation: popIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      position: relative;
      text-align: center;
      --mask: radial-gradient(10px at 50% 100%, #0000 98%, #000 100%) 50% calc(100% - 10px)/20px 100% repeat-x;
      -webkit-mask: var(--mask); 
      mask: var(--mask);
      padding-bottom: 60px;
    }

    /* PRESCRIPTION STYLES */
    .rx-pad {
      background: #fff0f5;
      padding: 25px;
      font-family: "Quicksand", sans-serif;
      color: #880e4f;
      box-shadow: 0 15px 50px rgba(0,0,0,0.15);
      animation: popIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      border: 4px solid #ff80ab;
      border-radius: 10px;
      position: relative;
    }
    
    .rx-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #ff80ab;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .rx-symbol { font-size: 2.5rem; font-weight: 900; font-family: serif; font-style: italic; }
    .rx-title { font-size: 0.8rem; font-weight: bold; text-align: right; }
    
    .rx-field { text-align: left; margin-bottom: 15px; }
    .rx-label { font-size: 0.7rem; font-weight: bold; opacity: 0.7; text-transform: uppercase; }
    .rx-value { font-size: 1.1rem; font-weight: 700; border-bottom: 1px dashed #ff80ab; padding-bottom: 2px; }
    
    .rx-handwritten {
      font-family: "Caveat", cursive;
      font-size: 1.6rem;
      color: #000080;
      margin-top: 5px;
      line-height: 1.2;
    }

    .rx-signature {
      margin-top: 30px;
      text-align: right;
      font-family: "Caveat", cursive;
      font-size: 1.5rem;
      border-top: 2px solid #ff80ab;
      display: inline-block;
      width: 100%;
      padding-top: 5px;
    }

    @keyframes popIn {
      0% { opacity: 0; transform: translateY(40px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* SHARED STYLES */
    .ascii-art { white-space: pre; font-size: 0.8rem; line-height: 1; margin-bottom: 10px; opacity: 0.8; font-weight: bold; }
    .header-bubble { display: inline-block; border: 2px solid var(--accent); border-radius: 50px; padding: 8px 25px; margin-bottom: 5px; }
    .header-bubble h2 { margin: 0; font-size: 1.4rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
    .est-text { font-size: 0.75rem; margin-bottom: 20px; opacity: 0.7; }
    .info-bubble { border: 2px solid var(--accent); border-radius: 22px; padding: 15px; margin-bottom: 20px; font-size: 0.85rem; line-height: 1.6; text-align: center; background: rgba(255,255,255,0.1); }
    .item-list { text-align: left; margin-bottom: 20px; padding: 0 5px; }
    .item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; }
    .checklist-item { margin-bottom: 12px; font-size: 1rem; text-align: left; display: flex; align-items: center; gap: 10px;}
    .divider { border-top: 2px dashed var(--accent); margin: 20px 0; opacity: 0.5; }
    .total { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; color: var(--accent); }
    
    .loyalty-section { margin-top: 25px; border: 1px solid var(--accent); border-radius: 15px; padding: 12px; font-size: 0.8rem; background: rgba(255,255,255,0.3); }
    .stamps { font-size: 1.5rem; letter-spacing: 5px; margin-top: 5px; }
    .bottom-extras { margin-top: 25px; }
    .coupon { border: 2px dashed var(--accent); padding: 10px; font-weight: bold; font-size: 0.85rem; transform: rotate(-1deg); }
    .forecast { font-size: 0.7rem; opacity: 0.8; margin-bottom: 5px; }
    .barcode { margin-top: 15px; font-size: 2rem; opacity: 0.4; letter-spacing: -3px; transform: scaleY(0.7); }

    .report-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 20px; }
    .pixel { width: 18px; height: 18px; border-radius: 4px; background: #eee; }
    .stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; }
    .progress-bar { height: 8px; background: #eee; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); }

    .nav-btn {
      background: #ff80ab; color: white; border: none; padding: 8px 20px;
      border-radius: 20px; font-weight: bold; font-size: 0.8rem; cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="controls" id="controls">
    <input type="text" id="nameInput" class="name-box" placeholder="Your Name (or Secret Code)">
    <div class="sign-grid" id="signGrid"></div>
    <button class="menu-btn stats-btn" onclick="showReport()">üìä VIEW AURA REPORT</button>
    <button class="menu-btn rx-btn" onclick="showPrescription()">üíä GET PRESCRIPTION</button>
    <div class="trophy-bar" id="tierDisplay" style="margin-top:15px; font-size:0.75rem; text-align:center; opacity:0.7;">LOADING...</div>
  </div>

  <div class="receipt-container" id="receiptContainer">
    <div class="receipt">
      <div class="ascii-art" id="asciiDisplay"></div>
      <div class="header-bubble"><h2 id="storeName">LOADING...</h2></div>
      <div class="est-text" id="estText">est. 2026 ‚Ä¢ digital receipt</div>
      <div class="info-bubble" id="infoBubble"></div>
      <div class="item-list" id="itemList"></div>
      <div class="divider"></div>
      <div class="total">
        <span id="totalLabel">TOTAL:</span>
        <span id="totalText">$0.00</span>
      </div>
      <div class="loyalty-section" id="loyaltySection">
        <div style="font-weight:bold; font-size:0.75rem;" id="scentDisplay">SCENT: UNKNOWN</div>
        <div style="border-top:1px dashed var(--accent); opacity:0.3; margin:8px 0;"></div>
        <div>REWARD CARD:</div>
        <div class="stamps" id="stampsDisplay">‚ô°‚ô°‚ô°‚ô°‚ô°</div>
      </div>
      <div class="bottom-extras" id="bottomExtras"></div>
      
      <div style="margin-top:20px;" id="rxNavContainer">
        </div>
      <div style="text-align:center; color: var(--text); font-size:0.8rem; margin-top:15px; opacity:0.6; cursor: pointer;">( tap to go home )</div>
    </div>
  </div>

  <div class="rx-container" id="rxContainer">
    <div class="rx-pad">
      <div class="rx-header">
        <div class="rx-symbol">Rx</div>
        <div class="rx-title">DR. COSMIC, M.D.<br>SELF CARE CLINIC</div>
      </div>
      <div class="rx-field">
        <div class="rx-label">PATIENT NAME</div>
        <div class="rx-value" id="rxName">GUEST</div>
      </div>
      <div class="rx-field">
        <div class="rx-label">DIAGNOSIS</div>
        <div class="rx-handwritten" id="rxDiagnosis">LOADING...</div>
      </div>
      <div class="rx-field">
        <div class="rx-label">PRESCRIPTION / TREATMENT</div>
        <div class="rx-handwritten" id="rxTreatment">LOADING...</div>
      </div>
      <div class="rx-field">
        <div class="rx-label">REFILLS</div>
        <div class="rx-value">UNLIMITED</div>
      </div>
      <div class="rx-signature">Dr. Cosmic</div>
    </div>
    <div style="text-align:center; color: #880e4f; font-size:0.8rem; margin-top:20px; opacity:0.6; cursor: pointer;">( tap to go home )</div>
  </div>

  <div class="report-container" id="reportContainer">
    <div class="report">
      <div class="header-bubble"><h2>AURA REPORT</h2></div>
      <div class="est-text">official analysis ‚Ä¢ confidential</div>
      <div class="info-bubble" id="reportInfo"></div>
      <div style="text-align:left; font-size:0.8rem; font-weight:bold; margin-bottom:10px;">RECENT VIBES (LAST 30):</div>
      <div class="report-grid" id="pixelGrid"></div>
      <div class="divider"></div>
      <div style="text-align:left; font-size:0.8rem; font-weight:bold; margin-bottom:15px;">DOMINANT ERAS:</div>
      <div id="statsBars"></div>
      <div class="barcode">|| | ||| || |||</div>
      <div style="font-size:0.7rem; margin-top:10px; opacity:0.6;">END OF REPORT</div>
    </div>
    <div style="text-align:center; color: var(--text); font-size:0.8rem; margin-top:20px; opacity:0.6; cursor: pointer;">( tap to go home )</div>
  </div>

  <script>
    const shopNames = ["THE MALL", "GIRL WORLD", "PLASTIC DREAMS", "ARCHIVE", "ANGEL DEPT", "VELVET ROPE", "LIMITED ED.", "SOLDOUT", "MAIN CHAR."];
    const memberTitles = ["PASSENGER PRINCESS", "FORMER GIFTED KID", "LOCAL CRYPTID", "IPAD ADULT", "PROFESSIONAL NAPPER", "CAFFEINE DEPENDENT", "SILLY GOOSE", "ACADEMIC WEAPON", "CHRONICALLY ONLINE", "THEATRE KID", "HORSE GIRL", "SPACE CADET", "VINTED SELLER", "FANFICTION AUTHOR", "PLAYLIST CURATOR", "CAT MOM", "PLANT KILLER", "MALL RAT", "DEPARTMENT STORE GHOST", "PROFESSIONAL YEARNER", "CERTIFIED PRINCESS", "EMOTIONAL SUPPORT HUMAN", "DISCORD MOD", "REPLY GUY", "PINTEREST BOARD", "TUMBLR FAMOUS", "SLEEPY SOLDIER", "DRAMA QUEEN", "MAIN CHARACTER", "NPC", "SIDE CHARACTER", "VILLAIN ERA", "TIKTOK ADDICT", "SCREEN TIME VICTIM", "GIRL BLOGGER", "DIGITAL HOARDER", "STARGIRL", "CYBER ANGEL", "FOREST FAIRY", "DUNGEON MASTER", "GLITTER ENTHUSIAST", "BURNOUT VICTIM", "PROCRASTINATOR", "NIGHT OWL", "MORNING HATER", "WINDOW SHOPPER", "VIP", "INFLUENCER", "THE CHOSEN ONE"];
    const arts = { default: "‚ô•", nature: "    /\\\n   /  \\\n  /____\\ \n    ||", ocean: ".~ .~~~ ..~", stars: "‚ú®  ‚ú¶  ‚ú®", bow: "  /\\ /\\\n  ( o.o )\n   > ^ <", cyber: "[ o_o ]" };
    
    // --- UPDATED MEDICAL DATABASE (Opposite Action / Helpful Logic) ---
    const medicalDb = {
      rotting: {
        diagnoses: ["Bed-Gravity Syndrome", "Vitamin D Deficiency", "Vampire Mode", "Horizontal Life"],
        treatments: ["Open the Blinds", "Wash Your Face", "Drink 1 Glass of Water", "Stand Up for 1 Minute"]
      },
      thriving: {
        diagnoses: ["Main Character Energy", "Excessive Slay", "Glow Up Fever", "Momentum Spike"],
        treatments: ["Share the Energy", "Take a Selfie", "Write it Down", "Keep Going"]
      },
      manic: {
        diagnoses: ["System Overload", "Zoomies", "Chaos Mode", "Impulse Control Failure"],
        treatments: ["Lay on the Floor", "Box Breathing (4s)", "Put the Card Down", "Decaf Tea"]
      },
      numb: {
        diagnoses: ["Sensory Deprivation", "Static Noise Brain", "Auto-Pilot Mode", "The Void"],
        treatments: ["Hold an Ice Cube", "Eat Something Sour", "5 Jumping Jacks", "Cold Water Splash"]
      },
      delusional: {
        diagnoses: ["Fantasy Fever", "Reality Detachment", "Lover Girl Syndrome", "Plot Armor Check"],
        treatments: ["Call a Real Friend", "Touch a Wall", "Check Bank Account", "List 3 Facts"]
      },
      yearning: {
        diagnoses: ["Heart Acheness", "Nostalgia Poisoning", "Looking Backwards", "Soft Girl Flu"],
        treatments: ["Write & Burn It", "Close the Photo App", "Make New Art", "Call Someone New"]
      },
      hating: {
        diagnoses: ["Petty Fever", "Comparisonitis", "Grudge Holding", "Sour Candy Soul"],
        treatments: ["List 3 Good Things", "Compliment Someone", "Eat Something Sweet", "Log Off"]
      },
      healing: {
        diagnoses: ["Growth Spurt", "Boundary Setting", "Metamorphosis", "Inner Peace"],
        treatments: ["Rest & Hydrate", "Gentle Stretch", "Proud of You", "Slow Down"]
      },
      spiraling: {
        diagnoses: ["Looping Thoughts", "Panic Spike", "System Error", "Overthinking"],
        treatments: ["5-4-3-2-1 Method", "Weighted Blanket", "Call a Safe Person", "Look at the Sky"]
      },
      lurking: {
        diagnoses: ["Invisibility Cloak", "Perception Fear", "Digital Ghost", "Observer Mode"],
        treatments: ["Post a Comment", "Send a Text", "Be Perceived", "Step Away from Screen"]
      },
      posting: {
        diagnoses: ["Validation Seeking", "Performance Mode", "Influencer Influenza", "Caption Stress"],
        treatments: ["Airplane Mode (1hr)", "Read a Book", "Do Nothing", "Private Journaling"]
      },
      productive: {
        diagnoses: ["Hustle Culture Flu", "Human Doing", "Caffeine Overload", "Type A Virus"],
        treatments: ["Do Nothing (5m)", "Unclench Jaw", "Close Eyes", "Look at a Tree"]
      },
      general: { 
        diagnoses: ["Human Condition", "Vibe Shift", "Needs Maintenance", "Software Update"],
        treatments: ["Drink Water", "Deep Breath", "Be Kind to Self", "Touch Grass"]
      }
    };

    const moods = {
      rotting: { color: "#78909c", bg: "#eceff1", scent: "BEDSHEETS", art: arts.default, items: ["Doomscrolling", "Dirty Hair", "Uber Eats"] },
      thriving: { color: "#43a047", bg: "#e8f5e9", scent: "MATCHA", art: "üåø", items: ["Green Juice", "Yoga Mat", "Skin Glow"] },
      manic: { color: "#ff9100", bg: "#fff3e0", scent: "RED BULL", art: "‚ö°", items: ["Impulse Buy", "Fast Talking", "God Complex"] },
      numb: { color: "#bdbdbd", bg: "#fafafa", scent: "STATIC", art: "...", items: ["Staring at Wall", "Nothing", "White Noise"] },
      delusional: { color: "#f06292", bg: "#fce4ec", scent: "FROSTING", art: arts.bow, items: ["Fake Scenario", "He Loves Me", "Fantasy"] },
      yearning: { color: "#7e57c2", bg: "#ede7f6", scent: "RAIN", art: "‚òÅÔ∏è", items: ["Poetry", "Old Photos", "Sad Music"] },
      hating: { color: "#d32f2f", bg: "#ffebee", scent: "SMOKE", art: "‚úñ", items: ["Blocking Him", "Side Eye", "Judgment"] },
      healing: { color: "#8d6e63", bg: "#efebe9", scent: "SAGE", art: "üïØÔ∏è", items: ["Therapy", "Journaling", "Boundaries"] },
      spiraling: { color: "#304ffe", bg: "#e8eaf6", scent: "WINE", art: "üåÄ", items: ["Overthinking", "Panic", "Regret"] },
      lurking: { color: "#2e7d32", bg: "#e8f5e9", scent: "SCREEN", art: "üëÅÔ∏è", items: ["Screenshots", "Private Tab", "Research"] },
      posting: { color: "#00b0ff", bg: "#e1f5fe", scent: "HAIRSPRAY", art: "üì∏", items: ["Drafts", "Clout", "Validation"] },
      productive: { color: "#fdd835", bg: "#fffde7", scent: "PAPER", art: "üìù", items: ["Emails", "Iced Coffee", "To-Do List"] }
    };

    const secrets = {
      "lottie": { color: "#00ffff", bg: "#001e3c", paper: "#002845", store: "ATLANTIS", art: arts.ocean, item: "Pearl", scent: "DEEP SEA" },
      "matt": { color: "#2e4e34", bg: "#1b3323", paper: "#d7ccc8", store: "SEQUOIA", art: arts.nature, item: "Mossy Log", scent: "PINE" },
      "doll": { color: "#880e4f", bg: "#212121", paper: "#ffebee", store: "MORUTE", art: arts.bow, item: "Porcelain", scent: "LACE" },
      "cyber": { color: "#00e676", bg: "#000000", paper: "#1a1a1a", store: "SYSTEM_32", art: arts.cyber, item: "Data", scent: "OZONE" },
      "angel": { color: "#ffd700", bg: "#fffde7", paper: "#ffffff", store: "HEAVEN", art: arts.stars, item: "Halo", scent: "VANILLA" }
    };

    const commonItems = [{name: "Iced Oat Latte", price: 8.50}, {name: "Sonny Angel", price: 12.00}, {name: "Claw Clip", price: 5.00}, {name: "Satin Ribbon", price: 2.50}, {name: "Platform Shoes", price: 120.00}, {name: "Blind Box", price: 15.00}, {name: "Digicam", price: 250.00}, {name: "Phone Charm", price: 10.00}, {name: "Unread Book", price: 18.00}, {name: "Thrift Find", price: 25.00}, {name: "Delivery Fee", price: 5.99}, {name: "Strawberry Milk", price: 3.50}, {name: "Tote Bag", price: 20.00}, {name: "Face Mask", price: 4.00}, {name: "Concert Tickets", price: 300.00}, {name: "New Piercing", price: 60.00}, {name: "Vending Machine", price: 2.00}, {name: "Oat Milk Tax", price: 1.00}, {name: "Lip Gloss", price: 12.00}, {name: "Girl Dinner", price: 8.00}, {name: "Therapy", price: 150.00}, {name: "Little Walk", price: 0.00}, {name: "Sweet Treat", price: 5.00}, {name: "Spotify Premium", price: 11.99}];
    const selfCareTasks = ["Drink water", "Face mask", "Phone DND 1hr", "Stretch", "Clean a corner", "Listen to music", "Go outside", "Unclench jaw"];
    const fortunes = ["LUCKY NUMBER: 444", "AURA: PINK", "MANIFESTING: $$$", "VIBE: IMMACULATE", "AVOID: EXES"];
    const coupons = ["VALID FOR: 1 NAP", "VOUCHER: 1 FREE CRY", "ADMIT ONE: TO THE DRAMA", "COUPON: TREAT YOURSELF"];

    // --- DATA ---
    let lifetimeSpend = parseFloat(localStorage.getItem('loyaltySpend') || 0);
    let totalReceipts = parseInt(localStorage.getItem('loyaltyCount') || 0);
    let moodCounts = JSON.parse(localStorage.getItem('loyaltyMoods') || '{}');
    let moodHistory = JSON.parse(localStorage.getItem('loyaltyHistory') || '[]');

    function getSignatureScent() {
      let topMood = "numb"; let max = 0;
      for (const [m, c] of Object.entries(moodCounts)) { if (c > max) { max = c; topMood = m; } }
      return moods[topMood] ? moods[topMood].scent : "UNKNOWN";
    }
    
    function getTopMood() {
      let topMood = "general"; let max = 0;
      for (const [m, c] of Object.entries(moodCounts)) { if (c > max) { max = c; topMood = m; } }
      return topMood;
    }

    function updateDisplay() {
      document.getElementById('tierDisplay').innerText = `TOTAL SPENT: $${Math.floor(lifetimeSpend)}`;
    }

    // --- INIT ---
    const grid = document.getElementById('signGrid');
    Object.keys(moods).forEach(key => {
      const btn = document.createElement('button');
      btn.className = 'sign-btn';
      btn.innerText = key;
      btn.onclick = () => generate(key);
      grid.appendChild(btn);
    });
    updateDisplay();

    // --- FUNCTIONS ---
    function showReport() {
      const nameDisplay = document.getElementById('nameInput').value || "Guest";
      const topMood = getTopMood();
      document.getElementById('reportInfo').innerHTML = `SUBJECT: ${nameDisplay.toUpperCase()}<br>CURRENT ERA: ${topMood.toUpperCase()}<br>TOTAL ENTRIES: ${totalReceipts}`;
      const pixelDiv = document.getElementById('pixelGrid');
      pixelDiv.innerHTML = '';
      const recent = moodHistory.slice(-30);
      for(let i=0; i < 30; i++) {
        const px = document.createElement('div');
        px.className = 'pixel';
        if (recent[i]) { px.style.background = moods[recent[i]].color; }
        pixelDiv.appendChild(px);
      }
      let barsHtml = '';
      const sorted = Object.entries(moodCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
      sorted.forEach(([m, count]) => {
        const pct = Math.round((count / totalReceipts) * 100);
        barsHtml += `<div class="stat-row"><span>${m.toUpperCase()}</span><span>${pct}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${moods[m].color}"></div></div>`;
      });
      document.getElementById('statsBars').innerHTML = barsHtml;
      document.getElementById('controls').style.display = 'none';
      document.getElementById('reportContainer').style.display = 'block';
    }

    function showPrescription(specificMood = null) {
      const nameDisplay = document.getElementById('nameInput').value || "Guest";
      document.getElementById('rxName').innerText = nameDisplay.toUpperCase();
      
      let targetMood = "general";
      if (specificMood) {
        targetMood = specificMood;
      } else {
        targetMood = getTopMood();
        if (moodHistory.length === 0) targetMood = "general";
      }
      
      const data = medicalDb[targetMood] || medicalDb.general;
      const randomDiag = data.diagnoses[Math.floor(Math.random() * data.diagnoses.length)];
      const randomTreat = data.treatments[Math.floor(Math.random() * data.treatments.length)];
      
      document.getElementById('rxDiagnosis').innerText = randomDiag;
      document.getElementById('rxTreatment').innerText = randomTreat;

      document.getElementById('controls').style.display = 'none';
      document.getElementById('receiptContainer').style.display = 'none';
      document.getElementById('rxContainer').style.display = 'block';
    }

    function generate(moodKey) {
      const nameRaw = document.getElementById('nameInput').value.trim().toLowerCase();
      const nameDisplay = document.getElementById('nameInput').value || "Guest";
      
      let theme = moods[moodKey];
      let storeName = shopNames[Math.floor(Math.random() * shopNames.length)];
      let paperColor = "#ffffff";
      let bonusItem = null;
      let ascii = theme.art || arts.default;
      let scentOverride = null;

      if (secrets[nameRaw]) {
        const s = secrets[nameRaw];
        theme = { color: s.color, bg: s.bg };
        storeName = s.store;
        paperColor = s.paper;
        ascii = s.art || arts.stars;
        scentOverride = s.scent;
        bonusItem = { name: s.item, price: 999.00 };
      }

      document.documentElement.style.setProperty('--bg', theme.bg);
      document.documentElement.style.setProperty('--accent', theme.color);
      document.documentElement.style.setProperty('--text', theme.color);
      document.documentElement.style.setProperty('--paper', paperColor);
      
      moodCounts[moodKey] = (moodCounts[moodKey] || 0) + 1;
      localStorage.setItem('loyaltyMoods', JSON.stringify(moodCounts));
      moodHistory.push(moodKey);
      if (moodHistory.length > 50) moodHistory.shift(); 
      localStorage.setItem('loyaltyHistory', JSON.stringify(moodHistory));
      totalReceipts++;
      localStorage.setItem('loyaltyCount', totalReceipts);

      const isReward = (totalReceipts % 5 === 0);
      
      if (isReward) {
        document.getElementById('storeName').innerText = "SELF CARE";
        document.getElementById('estText').innerText = "reward menu ‚Ä¢ you earned this";
        document.getElementById('asciiDisplay').innerText = "‚ô°";
        document.getElementById('infoBubble').innerHTML = `CUSTOMER: ${nameDisplay.toUpperCase()}<br>STATUS: <b>REWARD UNLOCKED</b>`;
        const tasks = selfCareTasks.sort(() => 0.5 - Math.random()).slice(0, 5);
        let html = '';
        tasks.forEach(t => html += `<div class="checklist-item">‚òê ${t}</div>`);
        document.getElementById('itemList').innerHTML = html;
        document.getElementById('totalLabel').innerText = "COST:";
        document.getElementById('totalText').innerText = "PRICELESS";
        document.getElementById('loyaltySection').style.display = 'none';
        document.getElementById('bottomExtras').innerHTML = `<div class="forecast">ENJOY YOUR BREAK</div>`;
        document.getElementById('rxNavContainer').innerHTML = ``; 

      } else {
        document.getElementById('storeName').innerText = storeName;
        document.getElementById('estText').innerText = "est. 2026 ‚Ä¢ digital receipt";
        document.getElementById('asciiDisplay').innerText = ascii;
        document.getElementById('loyaltySection').style.display = 'block';

        let currentTotal = 0;
        let pool = [...commonItems];
        moods[moodKey].items.forEach(i => pool.push({name: i, price: 20.00}));
        const count = Math.floor(Math.random() * 3) + 3;
        const shuffled = pool.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, count);
        if (bonusItem) selected.unshift(bonusItem);

        let html = '';
        selected.forEach(i => {
          currentTotal += i.price;
          html += `<div class="item"><span>1x ${i.name}</span><span>$${i.price.toFixed(2)}</span></div>`;
        });
        document.getElementById('itemList').innerHTML = html;
        document.getElementById('totalLabel').innerText = "TOTAL:";
        document.getElementById('totalText').innerText = `$${currentTotal.toFixed(2)}`;

        lifetimeSpend += currentTotal;
        localStorage.setItem('loyaltySpend', lifetimeSpend);
        
        const randomIdentity = memberTitles[Math.floor(Math.random() * memberTitles.length)];
        document.getElementById('infoBubble').innerHTML = `CUSTOMER: ${nameDisplay.toUpperCase()}<br>MEMBER: ${randomIdentity}<br>LIFETIME DEBT: $${lifetimeSpend.toFixed(0)}`;
        const finalScent = scentOverride || getSignatureScent();
        document.getElementById('scentDisplay').innerText = `SIGNATURE SCENT: ${finalScent}`;
        const stampsFilled = totalReceipts % 5;
        let stampString = "";
        for(let i=0; i<5; i++) stampString += (i < stampsFilled) ? "‚ô• " : "‚ô° ";
        document.getElementById('stampsDisplay').innerText = stampString;

        const bottomDiv = document.getElementById('bottomExtras');
        if (Math.random() < 0.3) {
           const coup = coupons[Math.floor(Math.random() * coupons.length)];
           bottomDiv.innerHTML = `<div class="coupon">‚úÇ ${coup} ‚úÇ</div>`;
        } else {
           const fort = fortunes[Math.floor(Math.random() * fortunes.length)];
           bottomDiv.innerHTML = `<div class="forecast">${fort}</div><div class="barcode">|| | ||| || |||</div>`;
        }

        // UPDATE RX NAV BUTTON WITH SPECIFIC MOOD
        document.getElementById('rxNavContainer').innerHTML = `<button class="nav-btn" onclick="showPrescription('${moodKey}')">NEED TREATMENT?</button>`;
      }

      document.getElementById('controls').style.display = 'none';
      document.getElementById('receiptContainer').style.display = 'block';
    }

    document.addEventListener('click', (e) => {
      // Close Receipt
      const rec = document.getElementById('receiptContainer');
      if (rec.style.display === 'block' && (e.target.closest('.receipt-container') || e.target.closest('.receipt'))) {
        if (!e.target.classList.contains('nav-btn')) {
            document.getElementById('controls').style.display = 'flex';
            rec.style.display = 'none';
            document.getElementById('nameInput').value = ""; 
            updateDisplay();
        }
      }
      // Close Report
      const rep = document.getElementById('reportContainer');
      if (rep.style.display === 'block' && (e.target.closest('.report-container') || e.target.closest('.report'))) {
        document.getElementById('controls').style.display = 'flex';
        rep.style.display = 'none';
      }
      // Close Rx
      const rx = document.getElementById('rxContainer');
      if (rx.style.display === 'block' && (e.target.closest('.rx-container') || e.target.closest('.rx-pad'))) {
        document.getElementById('controls').style.display = 'flex';
        rx.style.display = 'none';
      }
    });

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
